var $testDivs = null;
var $profileDivs = null;
var $offerDivs = null;
$(document).ready(function () {
    $("#no-search-items").hide();
    $(".covered").each(function () {
        var highestBox = 0;
        $(".column", this).each(function () {
            if ($(this).height() > highestBox) {
                highestBox = $(this).height();
            }
        });
        $(".column", this).height(highestBox);
    });

    
    //window.onscroll = function () {
    //    scrollFunction();
    //};
    $testDivs = $("#thyrocareTests-container > div");
    $profileDivs = $("#thyrocareProfiles-container > div");
    $offerDivs = $("#thyrocareOffers-container > div");
    var addBtns = $(".hidden-add-beneficiary-btn");
    $.each(addBtns, function (index, element) {
        if (index === addBtns.length - 1) {
            $(element).css("display", "block");
        } else {
            $(element).css("display", "none");
        }
    });
    changeSelectedItemStatus();
});

function addItemToCart(context, isBookNow) {    
    //if (!isBookNow) {
    //    $(context).children()[1].innerHTML = Delete_From_Cart;
    //}
    $(context).parent().parent().parent().css("background-color", "gray");
    addItemToGlobalList($(context).find(".hide").html());
    if (isBookNow) {
        window.location.href = "~/cart";
    }
}

function changeSelectedItemStatus() {
    var $testDivs = $("#thyrocareTests-container > div");
    var $profileDivs = $("#thyrocareProfiles-container > div");
    var $offersDivs = $("#thyrocareOffers-container > div");

    var cartItems = JSON.parse(localStorage.getItem("ITEMS"));
    if (!cartItems || Object.keys(cartItems).length < 1) {
        return;
    }
    if ($testDivs.length) {
        _.map($testDivs, changeStatus);
    }
    if ($profileDivs.length) {
        _.map($profileDivs, changeStatus);
    }
    if ($offersDivs.length) {
        _.map($offersDivs, changeStatus);
    }

    

    function changeStatus(element) {
        var itemObj = $($(element).find(".hide")[0]).html();
        itemObj = itemObj.replace(/<[!-\w\/]*>/gi, emptyString);
        try {
            itemObj = JSON.parse(itemObj);
        } catch (e) {
            console.log("error : ", e, itemObj);
        }
        if (cartItems[itemObj.code]) {
            $(element).children().addClass("item-in-cart");
            //$(element).find(".cart-test > a").text(Delete_From_Cart)
        }
    }

}


$(function () {
    if (window.location.href.indexOf("?searchQuery=aarogyam") > -1) {
        //$("#packageType").val('aarogyam');
        setTimeout(function () {
            $("#packageType").val('aarogyam');
        }, 5);
    }
});

$("#sort-btn").on("change", function (event) {
    $("#no-search-items").hide();
    var $testDivs = $("#thyrocareTests-container > div");
    var $profileDivs = $("#thyrocareProfiles-container > div");
    var $offersDivs = $("#thyrocareOffers-container > div");
    var packageType = $("#packageType").val().toLowerCase();
    var sortType = event.target.value;
    if (packageType == "test") {
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, -1, false);
        }
        $("#thyrocareTests-container").html(alphabeticallyOrderedDivs);
    } else if (packageType == "profile") {
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, -1, false);
        }
        $("#thyrocareProfiles-container").html(alphabeticallyOrderedDivs);
    } else if (packageType == "offer") {
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, -1, false);
        }
        $("#thyrocareOffers-container").html(alphabeticallyOrderedDivs);
    } else {
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($testDivs, -1, false);
        }
        $("#thyrocareTests-container").html(alphabeticallyOrderedDivs);
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($profileDivs, -1, false);
        }
        $("#thyrocareProfiles-container").html(alphabeticallyOrderedDivs);
        if (sortType === "a-z") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, 1, true);
        } else if (sortType === "z-a") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, -1, true);
        } else if (sortType == "low") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, 1, false);
        } else if (sortType == "high") {
            var alphabeticallyOrderedDivs = getSortedDivs($offersDivs, -1, false);
        }
        $("#thyrocareOffers-container").html(alphabeticallyOrderedDivs);
    }
});
$("#package-profile").click(function () {
    $("#no-search-items").hide();
    $("#packageType").val("profile");
    filterByType();
});
$("#package-offer").click(function () {
    $("#no-search-items").hide();
    $("#packageType").val("offer");
    filterByType();
});
$("#package-test").click(function () {
    $("#no-search-items").hide();
    $("#packageType").val("test");
    filterByType();
});

function getSortedDivs(divsToSort, ascDesc, name) {
    if (ascDesc === 1) {
        return divsToSort.sort(function (a, b) {
            return name ? $(a).find("p").text().charCodeAt(0) - $(b).find("p").text().charCodeAt(0) : Number($(a).find("h5").text()) - Number($(b).find("h5").text())
        });
    } else {
        return divsToSort.sort(function (a, b) {
            return name ? $(b).find("p").text().charCodeAt(0) - $(a).find("p").text().charCodeAt(0) : Number($(b).find("h5").text()) - Number($(a).find("h5").text())
        });
    }
}
$("#fastingType").on("change", function (event) {
    var fastingType = event.target.value;
    filterByFasting(fastingType);
});

function applyPromoCode(val) {
    if (val == emptyString) {
        alertModal(true, {
            title: "Promocode not entered",
            body: "Please enter the promocode"
        });
        return;
    }
    getOffersByPromocode(val, showOffersFromPromocodeData);
}
$("#promocode-text").on("keyup", function (event) {
    if (event.keyCode == 13) {
        applyPromoCode(event.target.value.trim());
    }
});

function applyPromoHandler(event) {
    var val = $("#promocode-text").val();
    applyPromoCode(val);
}

function getParameterByNameFromUrl(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return emptyString;
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
//$(document).ready(function () {
//    $(".owl-carousel").owlCarousel({
//        loop: true,
//        margin: 10,
//        responsiveClass: true,
//        navText: ["<i class='glyphicon glyphicon-chevron-left'></i>", "<i class='glyphicon glyphicon-chevron-right'></i>"],
//        responsive: {
//            0: {
//                items: 1,
//                nav: true
//            },
//            600: {
//                items: 3,
//                nav: false
//            },
//            1e3: {
//                items: 4,
//                nav: true,
//                loop: false,
//                margin: 20
//            }
//        }
//    });
//    var currentUrl = window.location.href;
//    var searchQuery = getParameterByNameFromUrl("searchQuery", currentUrl);
//    if (searchQuery && searchQuery !== emptyString) {
//        $("#search").val(searchQuery);
//        searchByName(searchQuery);
//    }
//});

function searchByName(searchTerm) {
    var containerElement = emptyString;
    var packageType = $("#packageType").val();
    var isFound = false;
    containerElement = ["#thyrocareProfiles", "#thyrocareTest", "#thyrocareOffers"];
    containerElement.map(function (container) {
        var profileElements = $(container).find(".packageNames");
        if (container != "#thyrocareOffers") {
            for (var i = 0; i < profileElements.length; i++) {
                if (profileElements[i].innerHTML.toLowerCase().indexOf(searchTerm.toLowerCase()) === -1) {
                    $($(profileElements[i]).parent().parent().parent()[0]).hide();
                } else {
                    isFound = true;
                    $($(profileElements[i]).parent().parent().parent()[0]).show();
                }
            }
        }
        else {
            for (var i = 0; i < profileElements.length; i++) {
                if (profileElements[i].innerHTML.toLowerCase().indexOf(searchTerm.toLowerCase()) === -1) {
                    $($(profileElements[i]).parent().parent().parent().parent().parent().parent()[0]).hide();
                } else {
                    isFound = true;
                    $($(profileElements[i]).parent().parent().parent().parent().parent().parent()[0]).show();
                }
            }
        }
    });
    if (!isFound) {
        $("#thyrocareProfiles").hide();
        $("#thyrocareTest").hide();
        $("#thyrocareOffers").hide();
        $("#no-search-items").show();
    } else {
        if (!$('#thyrocareProfiles .related-test-inner:visible').length)
            $("#thyrocareProfiles").hide();
        if (!$('#thyrocareTest .related-test-inner:visible').length)
            $("#thyrocareTest").hide();
        if (!$('#thyrocareOffers .related-test-inner:visible').length)
            $("#thyrocareOffers").hide();
        $("#packageType").val("all");
        filterByType();
    }
}
$("#carousel-example-generic6").on("slide.bs.carousel", function () { });
$(function () {
    var isValidDate = function (value, format) {
        format = format || false;
        if (format) {
            value = parseDate(value);
        }
        var timestamp = Date.parse(value);
        return isNaN(timestamp) == false;
    };
    var parseDate = function (value) {
        var m = value.match(/^(\d{1,2})(\/|-)?(\d{1,2})(\/|-)?(\d{4})$/);
        if (m) value = m[5] + "-" + ("00" + m[3]).slice(-2) + "-" + ("00" + m[1]).slice(-2);
        return value;
    };
});
$(function () {
    $("#chktest").click(function () {
        var container = $($(this).parents(".row")[0]);
        if ($(this).is(":checked")) {
            $("#dvtest").show();
            container.addClass("benificiary-highlight");
        } else {
            $("#dvtest").hide();
            container.removeClass("benificiary-highlight");
        }
    });
});

function highlight(self) {
    var container = $($(self).parents(".row")[0]);
    if ($(self).is(":checked")) {
        container.addClass("benificiary-highlight");
    } else {
        container.removeClass("benificiary-highlight");
    }
}

function tryGettingElements() {
    if (!$testDivs || $testDivs && $testDivs.length == 0) {
        $testDivs = $("#thyrocareTests-container > div");
    }
    if (!$profileDivs || $profileDivs && $profileDivs.length == 0) {
        $profileDivs = $("#thyrocareProfiles-container > div");
    }
    if (!$offerDivs || $offerDivs && $offerDivs.length == 0) {
        $offerDivs = $("#thyrocareOffers-container > div");
    }
}

function filterByPrice(minPrice, maxPrice, isOverMax) {
    var filteredTests = [];
    var filteredProfiles = [];
    var filteredOffers = [];
    var filteredProfilesHtmlStr = emptyString;
    var filteredTestsHtmlStr = emptyString;
    var filteredOffersHtmlStr = emptyString;
    tryGettingElements();
    if (isOverMax) {
        filteredProfiles = _.filter($profileDivs, function (item) {
            var data = $(item).find(".hide:first").html();
            data = JSON.parse(data);
            return data.rate.pay_amt >= minPrice;
        });
        filteredTests = _.filter($testDivs, function (item) {
            var data = JSON.parse($(item).find(".hide:first").html());
            return data.rate.pay_amt >= minPrice;
        });
        filteredOffers = _.filter($offerDivs, function (item) {
            var data = JSON.parse($(item).find(".hide:first").html());
            return data.rate.pay_amt >= minPrice;
        });
    } else {
        filteredProfiles = _.filter($profileDivs, function (item) {
            var data = $(item).find(".hide:first").html();
            data = JSON.parse(data);
            return data.rate.pay_amt >= minPrice && data.rate.pay_amt < maxPrice;
        });
        filteredTests = _.filter($testDivs, function (item) {
            var data = JSON.parse($(item).find(".hide:first").html());
            return data.rate.pay_amt >= minPrice && data.rate.pay_amt < maxPrice;
        });
        filteredOffers = _.filter($offerDivs, function (item) {
            var data = JSON.parse($(item).find(".hide:first").html());
            return data.rate.pay_amt >= minPrice && data.rate.pay_amt < maxPrice;
        });
    }
    filteredProfiles.map(function (item) {
        filteredProfilesHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
    });
    filteredTests.map(function (item) {
        filteredTestsHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
    });
    filteredOffers.map(function (item) {
        filteredOffersHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
    });
    $("#thyrocareProfiles-container").html(filteredProfilesHtmlStr);
    $("#thyrocareOffers-container").html(filteredOffersHtmlStr);
    $("#thyrocareTests-container").html(filteredTestsHtmlStr);
}

//function filterByFasting(fastingType) {
//    console.log("fastingType", fastingType);
//    var filteredTests = [];
//    var filteredProfiles = [];
//    var filteredOffers = [];
//    var filteredProfilesHtmlStr = emptyString;
//    var filteredTestsHtmlStr = emptyString;
//    var filteredOffersHtmlStr = emptyString;
//    tryGettingElements();
//    if (fastingType == "fasting") {
//        filteredProfiles = _.filter($profileDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "CF";
//        });
//        filteredTests = _.filter($testDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "CF";
//        });
//        filteredOffers = _.filter($offerDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "CF";
//        })
//    } else if (fastingType == "notFasting") {
//        filteredProfiles = _.filter($profileDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "NF";
//        });
//        filteredTests = _.filter($testDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "NF";
//        });
//        filteredOffers = _.filter($offerDivs, function (item) {
//            var data = JSON.parse($(item).find(".hide:first").html());
//            return data.fasting == "NF";
//        });
//    } else {
//        filteredProfiles = _.filter($profileDivs, function (item) {
//            return true;
//        });
//        filteredTests = _.filter($testDivs, function (item) {
//            return true;
//        });
//        filteredOffers = _.filter($offerDivs, function (item) {
//            return true;
//        });
//    }
//    filteredProfiles.map(function (item) {
//        filteredProfilesHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
//    });
//    filteredTests.map(function (item) {
//        filteredTestsHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
//    });
//    filteredOffers.map(function (item) {
//        filteredOffersHtmlStr += '<div class="col-md-4 related-test-inner">' + item.innerHTML + "</div>";
//    });
//    $("#thyrocareProfiles-container").html(filteredProfilesHtmlStr);
//    $("#thyrocareOffers-container").html(filteredOffersHtmlStr);
//    $("#thyrocareTests-container").html(filteredTestsHtmlStr);
//}